<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Takip Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px; margin: 0 auto; background: white;
            border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .auth-section, .app-section { display: none; }
        .auth-section.active, .app-section.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input, select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 16px; transition: border-color 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        .btn-small {
            padding: 8px 16px; font-size: 13px; width: auto;
            display: inline-block; margin: 5px;
        }
        .user-info {
            background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .tabs, .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab, .sub-tab {
            flex: 1; min-width: 100px; padding: 12px; background: #f0f0f0;
            border: none; border-radius: 10px; cursor: pointer;
            font-weight: 600; font-size: 14px;
        }
        .tab.active, .sub-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sub-tabs { margin-top: 20px; }
        .card {
            background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;
            border: 2px solid #e0e0e0; transition: all 0.3s;
        }
        .card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .card-title {
            font-weight: 600; color: #667eea; margin-bottom: 10px;
            font-size: 18px; display: flex; justify-content: space-between; align-items: center;
        }
        .clickable-title {
            cursor: pointer;
            transition: color 0.2s;
        }
        .clickable-title:hover {
            color: #764ba2;
        }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .success { background: #efe; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .role-badge {
            display: inline-block; padding: 4px 10px; border-radius: 15px;
            font-size: 11px; font-weight: 600; margin-left: 10px;
        }
        .role-admin { background: #ef4444; color: white; }
        .role-coach { background: #10b981; color: white; }
        .role-student { background: #3b82f6; color: white; }
        .role-pending { background: #f59e0b; color: white; }
        .stats-info {
            display: flex; gap: 15px; font-size: 14px;
            color: #666; flex-wrap: wrap; margin-top: 10px;
        }
        .chart-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section active" id="authSection">
		<h3 style="text-align: center; font-weight: 600; color: #4a5568; margin-bottom: 25px; font-size: 16px; letter-spacing: 0.5px;">
                MEHMET CANAN ÖZYAŞAR ANADOLU LİSESİ
            </h3>
            <h1>📚 Soru Takip Sistemi</h1>
            <p class="subtitle">Günlük soru çözüm takibinizi yapın</p>
            <div id="authMessage"></div>
            <div class="input-group">
                <label>E-posta</label>
                <input type="email" id="emailInput" placeholder="ornek@email.com">
            </div>
            <div class="input-group">
                <label>Şifre</label>
                <input type="password" id="passwordInput" placeholder="En az 6 karakter">
            </div>
            <div class="input-group" id="nameGroup" style="display:none;">
                <label>Ad Soyad</label>
                <input type="text" id="nameInput" placeholder="Adınız ve soyadınız">
            </div>
            <div class="input-group" id="coachGroup" style="display:none;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="isCoachCheckbox" style="width: auto; margin-right: 10px;">
                    <span>Öğretmen (Koç) olarak kayıt olmak istiyorum</span>
                </label>
            </div>
            <div class="input-group" id="selectCoachGroup" style="display:none;">
                <label>Koçunuzu Seçin</label>
                <select id="coachSelect">
                    <option value="">Koç seçin...</option>
                </select>
            </div>
            <button id="signUpBtn" style="display:none;">Kayıt Ol</button>
            <button id="signInBtn">Giriş Yap</button>
            <button class="btn-secondary" id="toggleModeBtn">Hesabım yok, kayıt ol</button>
        </div>

        <div class="app-section" id="appSection">
            <div id="appMessage"></div>
            <div class="user-info">
                <div>
                    <strong id="userName">Kullanıcı</strong>
                    <span id="userRole"></span>
                    <div style="font-size: 12px; color: #666;" id="userEmail"></div>
                </div>
                <button class="btn-small btn-secondary" id="logoutBtn">Çıkış</button>
            </div>
            <div id="tabsContainer"></div>
            <div id="contentContainer"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, Timestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDz0lFClcTpySHPCZnLEyXWHeQzd9RyH58",
            authDomain: "mcoalogrencikocluk.firebaseapp.com",
            projectId: "mcoalogrencikocluk",
            storageBucket: "mcoalogrencikocluk.firebasestorage.app",
            messagingSenderId: "950814379359",
            appId: "1:950814379359:web:970b00931d5e0763bdbaea"
        };

        // Firebase Servislerini Başlatma
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let isSignUpMode = false;
        let chartInstance = null;
        const ADMIN_EMAIL = "abdussametkrkmz@gmail.com";

        // DOM Elementleri
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const nameInput = document.getElementById('nameInput');
        const isCoachCheckbox = document.getElementById('isCoachCheckbox');
        const coachSelect = document.getElementById('coachSelect');
        const signUpBtn = document.getElementById('signUpBtn');
        const signInBtn = document.getElementById('signInBtn');
        const toggleModeBtn = document.getElementById('toggleModeBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const tabsContainer = document.getElementById('tabsContainer');
        const contentContainer = document.getElementById('contentContainer');

        // Olay Dinleyicileri
        signUpBtn.addEventListener('click', handleSignUp);
        signInBtn.addEventListener('click', handleSignIn);
        toggleModeBtn.addEventListener('click', toggleAuthMode);
        logoutBtn.addEventListener('click', handleSignOut);
        isCoachCheckbox.addEventListener('change', handleCoachCheckboxChange);

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('nameGroup').style.display = isSignUpMode ? 'block' : 'none';
            document.getElementById('coachGroup').style.display = isSignUpMode ? 'block' : 'none';
            signUpBtn.style.display = isSignUpMode ? 'block' : 'none';
            signInBtn.style.display = isSignUpMode ? 'none' : 'block';
            toggleModeBtn.textContent = isSignUpMode ? 'Zaten hesabım var, giriş yap' : 'Hesabım yok, kayıt ol';
            if (isSignUpMode) {
                loadApprovedCoaches();
                handleCoachCheckboxChange();
            } else {
                 document.getElementById('selectCoachGroup').style.display = 'none';
            }
        }

        function handleCoachCheckboxChange() {
            const isCoach = isCoachCheckbox.checked;
            document.getElementById('selectCoachGroup').style.display = isSignUpMode && !isCoach ? 'block' : 'none';
        }

        async function loadApprovedCoaches() {
            try {
                const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', true));
                const snapshot = await getDocs(q);
                coachSelect.innerHTML = '<option value="">Koç seçin...</option>';
                snapshot.forEach(docSnap => {
                    const coach = docSnap.data();
                    const option = document.createElement('option');
                    option.value = coach.uid;
                    option.textContent = coach.name;
                    coachSelect.appendChild(option);
                });
            } catch (error) {
                showMessage('Koçlar yüklenemedi: ' + error.message, 'error', 'auth');
            }
        }

        async function handleSignUp() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const name = nameInput.value.trim();
            const isCoach = isCoachCheckbox.checked;
            const selectedCoach = coachSelect.value;
            if (!email || !password || !name) { showMessage('Lütfen tüm alanları doldurun', 'error', 'auth'); return; }
            if (!isCoach && !selectedCoach) { showMessage('Lütfen bir koç seçin', 'error', 'auth'); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await addDoc(collection(db, 'users'), {
                    uid: userCredential.user.uid, email: email, name: name,
                    role: isCoach ? 'coach' : 'student',
                    approved: isCoach ? false : true,
                    coachId: isCoach ? null : selectedCoach,
                    createdAt: Timestamp.now()
                });
                showMessage(isCoach ? 'Kayıt başarılı! Hesabınızın yönetici tarafından onaylanması gerekiyor.' : 'Kayıt başarılı! Giriş yapabilirsiniz.', 'success', 'auth');
                toggleAuthMode();
            } catch (error) { showMessage('Kayıt hatası: ' + error.message, 'error', 'auth'); }
        }

        async function handleSignIn() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || !password) { showMessage('Lütfen e-posta ve şifre girin', 'error', 'auth'); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showMessage('Giriş başarısız: ' + error.message, 'error', 'auth'); }
        }

        async function handleSignOut() {
            try { await fbSignOut(auth); window.location.reload(); }
            catch (error) { showMessage('Çıkış yapılamadı', 'error', 'app'); }
        }

        function showMessage(msg, type, section) {
            const messageDiv = section === 'auth' ? document.getElementById('authMessage') : document.getElementById('appMessage');
            messageDiv.className = type;
            messageDiv.textContent = msg;
            setTimeout(() => { if (messageDiv.textContent === msg) { messageDiv.textContent = ''; } }, 5000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const q = query(collection(db, 'users'), where('uid', '==', user.uid));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { showMessage('Kullanıcı veritabanında bulunamadı', 'error', 'app'); await fbSignOut(auth); return; }
                userData = snapshot.docs[0].data();
                userData.docId = snapshot.docs[0].id;
                if (user.email === ADMIN_EMAIL) { userData.role = 'admin'; userData.approved = true; }
                if (userData.role === 'coach' && !userData.approved) { alert('Hesabınız henüz yönetici tarafından onaylanmadı.'); await fbSignOut(auth); return; }
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userEmail').textContent = user.email;
                let roleText = '', roleClass = '';
                if (userData.role === 'admin') { roleText = 'ADMİN'; roleClass = 'role-admin'; }
                else if (userData.role === 'coach') { roleText = 'KOÇ'; roleClass = 'role-coach'; }
                else { roleText = 'ÖĞRENCİ'; roleClass = 'role-student'; }
                document.getElementById('userRole').innerHTML = `<span class="role-badge ${roleClass}">${roleText}</span>`;
                authSection.classList.remove('active');
                appSection.classList.add('active');
                loadUserInterface();
            } else {
                currentUser = null; userData = null;
                authSection.classList.add('active');
                appSection.classList.remove('active');
            }
        });

        function loadUserInterface() {
            if (userData.role === 'admin') loadAdminInterface();
            else if (userData.role === 'coach') loadCoachInterface();
            else loadStudentInterface();
        }

        function setupTabEvents(callback, selector = '.tab') {
            document.querySelectorAll(selector).forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll(selector).forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    callback(e.target.dataset.tab);
                });
            });
        }

        function loadAdminInterface() {
            tabsContainer.innerHTML = `
                <div class="tabs">
                    <button class="tab active" data-tab="mystudents">Öğrencilerim</button>
                    <button class="tab" data-tab="allcoaches">Tüm Koçlar</button>
                    <button class="tab" data-tab="pending">Onay Bekleyenler</button>
                </div>`;
            setupTabEvents(showAdminTab);
            showAdminTab('mystudents');
        }

        async function showAdminTab(tabName) {
            contentContainer.innerHTML = '<div class="loading">Yükleniyor...</div>';
            if (tabName === 'mystudents') await loadMyStudents();
            else if (tabName === 'allcoaches') await window.loadAllCoaches();
            else if (tabName === 'pending') await loadPendingCoaches();
        }
        
        function loadCoachInterface() {
            tabsContainer.innerHTML = `
                <div class="tabs">
                    <button class="tab active" data-tab="mystudents">Öğrencilerim</button>
                    <button class="tab" data-tab="mystats">Haftalık İstatistikler</button>
                </div>`;
            setupTabEvents(showCoachTab);
            showCoachTab('mystudents');
        }

        async function showCoachTab(tabName) {
            if (tabName === 'mystudents') await loadMyStudents();
            else if (tabName === 'mystats') await loadCoachStats(currentUser.uid, contentContainer);
        }

// --- BU ÖĞRENCİ FONKSİYONLARINI GÜNCELLEYİN ---

        function loadStudentInterface() {
            tabsContainer.innerHTML = `<div class="tabs"><button class="tab active" data-tab="entry">Veri Gir</button><button class="tab" data-tab="mystats">İstatistiklerim</button></div>`;
            setupTabEvents(showStudentTab);
            showStudentTab('entry');
        }

        async function showStudentTab(tabName) {
            contentContainer.innerHTML = '<div class="loading">Yükleniyor...</div>';
            if (tabName === 'entry') loadEntryForm();
            else if (tabName === 'mystats') await loadMyStats();
        }

        function loadEntryForm() {
            contentContainer.innerHTML = `
                <div class="input-group"><label>Ders</label><select id="subjectInput">
                    <option value="">Ders seçin</option><option value="Türkçe">Türkçe</option><option value="Matematik">Matematik</option><option value="Fizik">Fizik</option><option value="Kimya">Kimya</option><option value="Biyoloji">Biyoloji</option><option value="Tarih">Tarih</option><option value="Coğrafya">Coğrafya</option><option value="Din Kültürü">Din Kültürü</option><option value="Felsefe">Felsefe</option><option value="Deneme Sınavı">Deneme Sınavı</option>
                </select></div>
                <div class="input-group"><label>Tarih</label><input type="date" id="dateInput"></div>
                <div class="input-group"><label>Çözülen Soru</label><input type="number" id="solvedInput" min="0" placeholder="0"></div>
                <div class="input-group"><label>Doğru</label><input type="number" id="correctInput" min="0" placeholder="0"></div>
                <div class="input-group"><label>Yanlış</label><input type="number" id="wrongInput" min="0" placeholder="0"></div>
                <button id="saveEntryBtn">Kaydet</button>
                <div id="entriesList" style="margin-top: 30px;"></div>
            `;
            document.getElementById('dateInput').valueAsDate = new Date();
            document.getElementById('saveEntryBtn').addEventListener('click', saveEntry);
            loadMyEntries();
        }

        async function saveEntry() {
            const subject = document.getElementById('subjectInput').value;
            const date = document.getElementById('dateInput').value;
            const solved = parseInt(document.getElementById('solvedInput').value) || 0;
            const correct = parseInt(document.getElementById('correctInput').value) || 0;
            const wrong = parseInt(document.getElementById('wrongInput').value) || 0;

            if (!subject || !date || solved === 0) { showMessage('Lütfen tüm alanları eksiksiz doldurun.', 'error', 'app'); return; }
            if(correct + wrong > solved) { showMessage('Doğru ve yanlış sayısı toplamı, çözülen soru sayısından fazla olamaz.', 'error', 'app'); return; }

            try {
                await addDoc(collection(db, 'entries'), {
                    uid: currentUser.uid, subject, date, solved, correct, wrong,
                    createdAt: Timestamp.now()
                });
                loadEntryForm();
                showMessage('Kayıt eklendi!', 'success', 'app');
            } catch (error) { showMessage('Hata: ' + error.message, 'error', 'app'); }
        }

        async function loadMyEntries() {
            const entriesList = document.getElementById('entriesList');
            if (!entriesList) return;
            entriesList.innerHTML = '<div class="loading">Kayıtlar yükleniyor...</div>';
            const q = query(collection(db, 'entries'), where('uid', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                entriesList.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Henüz kayıt yok</p>'; return;
            }

            let entries = [];
            snapshot.forEach(doc => entries.push({ id: doc.id, ...doc.data() }));
            entries.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

            let html = '<h3 style="margin-bottom: 15px;">Son Kayıtlarım</h3>';
            entries.forEach(entry => {
                html += `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>${entry.date}</strong>
                                <span style="margin-left:10px;background:#667eea;color:white;padding:4px 10px;border-radius:15px;font-size:12px;">${entry.subject}</span>
                            </div>
                            <button class="btn-small btn-danger" onclick="window.deleteEntry('${entry.id}')">Sil</button>
                        </div>
                        <div class="stats-info">
                            <span>📝 ${entry.solved} soru</span><span>✅ ${entry.correct} doğru</span><span>❌ ${entry.wrong} yanlış</span>
                        </div>
                    </div>
                `;
            });
            entriesList.innerHTML = html;
        }

        async function loadMyStats() {
            contentContainer.innerHTML = '<h3>İstatistiklerim</h3><div class="loading">Yükleniyor...</div>';
            const entriesQuery = query(collection(db, 'entries'), where('uid', '==', currentUser.uid));
            const snapshot = await getDocs(entriesQuery);

            let total = 0, correct = 0, wrong = 0;
            const subjectData = {};

            snapshot.forEach(doc => {
                const data = doc.data();
                total += data.solved || 0;
                correct += data.correct || 0;
                wrong += data.wrong || 0;
                if (!subjectData[data.subject]) { subjectData[data.subject] = { solved: 0 }; }
                subjectData[data.subject].solved += data.solved;
            });

            let html = `
                <div class="card"><h3>Genel Toplam</h3><div class="stats-info" style="margin-top:15px;">
                    <span>📝 ${total} soru</span><span>✅ ${correct} doğru</span><span>❌ ${wrong} yanlış</span>
                    <span>🎯 ${total > 0 ? Math.round((correct/total)*100) : 0}% başarı</span>
                </div></div>
                <div class="card"><h3>Derslere Göre Soru Dağılımı</h3>
                    <div class="chart-container"><canvas id="myStatsChart"></canvas></div>
                </div>
            `;
            contentContainer.innerHTML = html;
            
            if(Object.keys(subjectData).length > 0) { createChart('myStatsChart', subjectData); }
        }
        
        function createChart(canvasId, subjectData) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (chartInstance) { chartInstance.destroy(); }
            
            const labels = Object.keys(subjectData);
            const data = labels.map(label => subjectData[label].solved);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{
                    label: 'Çözülen Soru Sayısı', data: data,
                    backgroundColor: ['rgba(255, 99, 132, 0.5)','rgba(54, 162, 235, 0.5)','rgba(255, 206, 86, 0.5)','rgba(75, 192, 192, 0.5)','rgba(153, 102, 255, 0.5)','rgba(255, 159, 64, 0.5)'],
                    borderColor: ['rgba(255, 99, 132, 1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)'],
                    borderWidth: 1
                }]},
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        async function loadMyStudents() {
            contentContainer.innerHTML = '<div class="loading">Yükleniyor...</div>';
            const q = query(collection(db, 'users'), where('coachId', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>Öğrencilerim</h3><p style="text-align:center;color:#999;padding:20px;">Henüz öğrenciniz yok.</p>'; return; }
            let html = '<h3>Öğrencilerim</h3>';
            for (const docSnap of snapshot.docs) {
                const student = docSnap.data();
                const stats = await getStudentStats(student.uid);
                html += `
                    <div class="card">
                        <div class="card-title">${student.name}<button class="btn-small btn-danger" onclick="window.deleteStudent('${docSnap.id}', '${student.name}', '${student.uid}')">Öğrenciyi Sil</button></div>
                        <div style="font-size: 13px; color: #999;">${student.email}</div>
                        <div class="stats-info">
                            <span>📝 ${stats.total} soru</span><span>✅ ${stats.correct} doğru</span><span>❌ ${stats.wrong} yanlış</span>
                            <span>🎯 ${stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0}% başarı</span>
                        </div>
                    </div>`;
            }
            contentContainer.innerHTML = html;
        }
        
        window.loadAllCoaches = async function() {
            contentContainer.innerHTML = '<h3>Tüm Koçlar</h3><div class="loading">Yükleniyor...</div>';
            const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', true));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>Tüm Koçlar</h3><p style="text-align:center;color:#999;padding:20px;">Sistemde onaylı koç bulunmuyor.</p>'; return; }
            let html = '<h3>Tüm Koçlar</h3>';
            for (const docSnap of snapshot.docs) {
                const coach = docSnap.data();
                const studentCount = await getCoachStudentCount(coach.uid);
                html += `
                    <div class="card">
                        <div class="card-title">
                            <span class="clickable-title" onclick="window.showCoachDetailView('${coach.uid}', '${coach.name}')">${coach.name}</span>
                            ${coach.email !== ADMIN_EMAIL ? `<button class="btn-small btn-danger" onclick="window.deleteCoach('${docSnap.id}', '${coach.name}')">Koçu Sil</button>` : ''}
                        </div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 10px;">${coach.email}</div>
                        <div class="stats-info"><span>👥 ${studentCount} öğrenci</span></div>
                    </div>`;
            }
            contentContainer.innerHTML = html;
        }

        async function loadPendingCoaches() {
            contentContainer.innerHTML = '<h3>Onay Bekleyen Koçlar</h3><div class="loading">Yükleniyor...</div>';
            const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>Onay Bekleyen Koçlar</h3><p style="text-align:center;color:#999;padding:20px;">Onay bekleyen koç yok.</p>'; return; }
            let html = '<h3>Onay Bekleyen Koçlar</h3>';
            snapshot.forEach(docSnap => {
                const coach = docSnap.data();
                html += `
                    <div class="card">
                        <div class="card-title">${coach.name} <span class="role-badge role-pending">ONAY BEKLİYOR</span></div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 10px;">${coach.email}</div>
                        <button class="btn-small btn-success" onclick="window.approveCoach('${docSnap.id}', '${coach.name}')">Onayla</button>
                        <button class="btn-small btn-danger" onclick="window.rejectCoach('${docSnap.id}', '${coach.name}')">Reddet</button>
                    </div>`;
            });
            contentContainer.innerHTML = html;
        }
        
// --- BU FONKSİYONLARI GÜNCELLEYİN ---

        async function getStudentStats(uid) {
            const q = query(collection(db, 'entries'), where('uid', '==', uid));
            const snapshot = await getDocs(q);
            let total = 0, correct = 0, wrong = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                total += data.solved || 0;
                correct += data.correct || 0;
                wrong += data.wrong || 0;
            });
            return { total, correct, wrong };
        }

        async function getCoachStudentCount(coachId) {
            const q = query(collection(db, 'users'), where('coachId', '==', coachId));
            const snapshot = await getDocs(q);
            return snapshot.size;
        }

        window.deleteEntry = async function(entryId) {
            if (!confirm('Bu kaydı silmek istediğinizden emin misiniz?')) return;
            try { await deleteDoc(doc(db, 'entries', entryId)); showMessage('Kayıt silindi.', 'success', 'app'); loadMyEntries(); }
            catch (error) { showMessage('Silme hatası: ' + error.message, 'error', 'app'); }
        };

        window.approveCoach = async function(docId, name) {
            if (!confirm(`'${name}' adlı öğretmeni onaylıyor musunuz?`)) return;
            try { await updateDoc(doc(db, 'users', docId), { approved: true }); showMessage('Koç onaylandı.', 'success', 'app'); loadPendingCoaches(); }
            catch (error) { showMessage('Onaylama hatası: ' + error.message, 'error', 'app'); }
        };

        window.rejectCoach = async function(docId, name) {
            if (!confirm(`'${name}' adlı öğretmeni reddetmek istediğinizden emin misiniz? Bu işlem kullanıcının kaydını silecektir.`)) return;
            try { await deleteDoc(doc(db, 'users', docId)); showMessage('Koç kaydı reddedildi ve silindi.', 'success', 'app'); loadPendingCoaches(); }
            catch (error) { showMessage('Reddetme hatası: ' + error.message, 'error', 'app'); }
        };

        window.deleteCoach = async function(docId, name) {
            if (!confirm(`DİKKAT! '${name}' adlı koçu silmek üzeresiniz. Bu işlem geri alınamaz. Bu koça bağlı öğrenciler sahipsiz kalacaktır. Devam edilsin mi?`)) return;
            try { await deleteDoc(doc(db, 'users', docId)); showMessage('Koç silindi.', 'success', 'app'); window.loadAllCoaches(); }
            catch (error) { showMessage('Silme hatası: ' + error.message, 'error', 'app'); }
        }

        window.deleteStudent = async function(docId, name, studentUid) {
            if (!confirm(`DİKKAT! '${name}' adlı öğrenciyi ve öğrenciye ait TÜM soru kayıtlarını kalıcı olarak silmek istediğinizden emin misiniz?`)) return;
            try {
                const batch = writeBatch(db);
                const entriesQuery = query(collection(db, 'entries'), where('uid', '==', studentUid));
                const entriesSnapshot = await getDocs(entriesQuery);
                entriesSnapshot.forEach(doc => { batch.delete(doc.ref); });
                const userDocRef = doc(db, 'users', docId);
                batch.delete(userDocRef);
                await batch.commit();
                showMessage('Öğrenci ve tüm verileri silindi.', 'success', 'app');
                loadMyStudents();
            } catch (error) { showMessage('Öğrenci silme hatası: ' + error.message, 'error', 'app'); }
        };

        async function loadCoachStats(coachUid, container) {
            container.innerHTML = '<div class="loading">İstatistikler hesaplanıyor...</div>';
            const studentQuery = query(collection(db, 'users'), where('coachId', '==', coachUid));
            const studentSnapshot = await getDocs(studentQuery);
            if (studentSnapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">İstatistik gösterecek öğrenci bulunmuyor.</p>'; return; }
            const studentUids = studentSnapshot.docs.map(doc => doc.data().uid);
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            const entriesQuery = query(collection(db, 'entries'), where('uid', 'in', studentUids), where('date', '>=', sevenDaysAgoStr));
            const entriesSnapshot = await getDocs(entriesQuery);
            if (entriesSnapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Öğrencileriniz son 1 hafta içinde hiç soru girişi yapmamış.</p>'; return; }
            const subjectStats = {};
            entriesSnapshot.forEach(doc => {
                const entry = doc.data();
                if (!subjectStats[entry.subject]) { subjectStats[entry.subject] = { solved: 0, correct: 0, wrong: 0 }; }
                subjectStats[entry.subject].solved += entry.solved;
                subjectStats[entry.subject].correct += entry.correct;
                subjectStats[entry.subject].wrong += entry.wrong;
            });
            let html = '<h4>Son 1 Haftalık Ders Performansı</h4>';
            for (const subject in subjectStats) {
                const stats = subjectStats[subject];
                html += `
                    <div class="card">
                        <div class="card-title">${subject}</div>
                        <div class="stats-info">
                            <span>📝 ${stats.solved} soru</span><span>✅ ${stats.correct} doğru</span><span>❌ ${stats.wrong} yanlış</span>
                            <span>🎯 ${stats.solved > 0 ? Math.round((stats.correct/stats.solved)*100) : 0}% başarı</span>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

        window.showCoachDetailView = async function(coachUid, coachName) {
            contentContainer.innerHTML = `
                <button class="btn-secondary btn-small" style="margin-bottom: 15px;" onclick="window.loadAllCoaches()">‹ Tüm Koçlara Geri Dön</button>
                <h3>${coachName}</h3>
                <div class="sub-tabs">
                    <button class="sub-tab active" data-tab="students">Öğrenciler</button>
                    <button class="sub-tab" data-tab="stats">Haftalık İstatistikler</button>
                </div>
                <div id="coachDetailContent"><div class="loading">Yükleniyor...</div></div>`;
            const coachDetailContent = document.getElementById('coachDetailContent');
            const showDetailTab = async (tabName) => {
                if (tabName === 'students') {
                    await loadCoachStudents(coachUid, coachDetailContent);
                } else if (tabName === 'stats') {
                    await loadCoachStats(coachUid, coachDetailContent);
                }
            };
            setupTabEvents(showDetailTab, '.sub-tab');
            await showDetailTab('students');
        };
        
        async function loadCoachStudents(coachUid, container) {
            container.innerHTML = '<div class="loading">Öğrenciler yükleniyor...</div>';
            const q = query(collection(db, 'users'), where('coachId', '==', coachUid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Bu koça atanmış öğrenci yok.</p>'; return; }
            let html = '';
            for (const docSnap of snapshot.docs) {
                const student = docSnap.data();
                const stats = await getStudentStats(student.uid);
                html += `
                    <div class="card">
                        <div class="card-title">${student.name}</div>
                        <div style="font-size: 13px; color: #999;">${student.email}</div>
                        <div class="stats-info">
                           <span>📝 ${stats.total} soru</span><span>✅ ${stats.correct} doğru</span><span>❌ ${stats.wrong} yanlış</span>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

    </script>
</body>
</html>
