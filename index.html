<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Takip Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #667eea; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .auth-section, .app-section { display: none; }
        .auth-section.active, .app-section.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; }
        .btn-danger { background: #ef4444; margin-top: 0; } /* margin-top kaldÄ±rÄ±ldÄ± */
        .btn-back { background: #6b7280; margin-bottom: 20px; }
        .stats-card { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .entry-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #e0e0e0; }
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .entry-date { font-weight: 600; color: #333; }
        .entry-subject { display: inline-block; padding: 4px 12px; background: #667eea; color: white; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .btn-small { padding: 5px 12px; font-size: 12px; width: auto; }
        .entry-stats { display: flex; gap: 15px; font-size: 14px; color: #666; flex-wrap: wrap; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: #f0f0f0; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        canvas { max-width: 100%; }
        .student-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
        .student-card:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .student-name { font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 18px; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error, .success { padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .error { background: #fee; color: #c33; }
        .success { background: #efe; color: #3c3; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section active" id="authSection">
            <h1>ğŸ“š Soru Takip Sistemi</h1>
            <p class="subtitle">GÃ¼nlÃ¼k soru Ã§Ã¶zÃ¼m takibinizi yapÄ±n</p>
            <div id="authMessage"></div>
            <div class="input-group">
                <label>E-posta</label>
                <input type="email" id="emailInput" placeholder="ornek@email.com">
            </div>
            <div class="input-group">
                <label>Åifre</label>
                <input type="password" id="passwordInput" placeholder="En az 6 karakter">
            </div>
            <div class="input-group" id="nameGroup">
                <label>Ad Soyad</label>
                <input type="text" id="nameInput" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z">
            </div>
            <button id="signUpButton">KayÄ±t Ol</button>
            <button class="btn-secondary" id="signInButton">GiriÅŸ Yap</button>
        </div>

        <div class="app-section" id="appSection">
            <div class="user-info">
                <div>
                    <strong id="userName">KullanÄ±cÄ±</strong>
                    <div style="font-size: 12px; color: #666;" id="userEmail"></div>
                </div>
                <button class="btn-small btn-secondary" id="signOutButton">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            
            <div id="appMessage" style="margin-bottom: 15px;"></div>

            <div id="studentTabs" style="display:none;">
                <div class="tabs">
                    <button class="tab active" data-tab-target="entry">Veri Gir</button>
                    <button class="tab" data-tab-target="stats">Ä°statistikler</button>
                </div>
            </div>
            <div id="coachTabs" style="display:none;">
                <div class="tabs">
                    <button class="tab active" data-tab-target="stats">Ä°statistikler</button>
                    <button class="tab" data-tab-target="admin">TÃ¼m Ã–ÄŸrenciler</button>
                </div>
            </div>

            <div id="entryTab" style="display:none;">
                </div>
            <div id="statsTab" style="display:none;">
                <div id="studentStatsContent"></div>
                <div id="coachStatsContent"></div>
            </div>
            <div id="adminTab" style="display:none;">
                <div id="studentListView">
                    <h3 style="margin-bottom: 20px;">TÃ¼m Ã–ÄŸrenciler</h3>
                    <div id="allStudentsList" class="loading">YÃ¼kleniyor...</div>
                </div>
                <div id="studentDetailView" style="display:none;">
                    <button class="btn-back" id="backToStudentListButton">â† Geri DÃ¶n</button>
                    <h3 id="detailStudentName" style="margin-bottom: 20px;"></h3>
                    <div id="studentDetailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        // Firebase SDK'lerinden gerekli tÃ¼m fonksiyonlarÄ± import et
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, Timestamp, orderBy, setDoc, getDoc } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        // Firebase YapÄ±landÄ±rmasÄ±
        const firebaseConfig = {
            apiKey: "AIzaSyDz0lFClcTpySHPCZnLEyXWHeQzd9RyH58",
            authDomain: "mcoalogrencikocluk.firebaseapp.com",
            projectId: "mcoalogrencikocluk",
            storageBucket: "mcoalogrencikocluk.firebasestorage.app",
            messagingSenderId: "950814379359",
            appId: "1:950814379359:web:970b00931d5e0763bdbaea"
        };

        // Firebase'i BaÅŸlat
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Global DeÄŸiÅŸkenler
        let currentUser = null;
        let isCoach = false;
        let chartInstances = {};
        const COACH_EMAIL = "abdussametkrkmz@gmail.com";
        const SUBJECT_COLORS = { 'TÃ¼rkÃ§e': '#ef4444', 'Matematik': '#3b82f6', 'Fizik': '#8b5cf6', 'Kimya': '#10b981', 'Biyoloji': '#06b6d4', 'Tarih': '#f59e0b', 'CoÄŸrafya': '#14b8a6', 'Din KÃ¼ltÃ¼rÃ¼': '#ec4899', 'Felsefe': '#6366f1', 'Deneme SÄ±navÄ±': '#6b7280' };

        // === YARDIMCI FONKSÄ°YONLAR ===
        function showAuthMessage(msg, type) {
            const div = document.getElementById('authMessage');
            div.innerHTML = `<div class="${type}">${msg}</div>`;
            setTimeout(() => div.innerHTML = '', 4000);
        }

        function showAppMessage(msg, type) {
            const div = document.getElementById('appMessage');
            div.innerHTML = `<div class="${type}">${msg}</div>`;
            setTimeout(() => div.innerHTML = '', 4000);
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        // === KÄ°MLÄ°K DOÄRULAMA FONKSÄ°YONLARI ===
        const signUp = async () => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        const signIn = async () => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        const signOut = () => fbSignOut(auth).catch(() => showAuthMessage('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±', 'error'));

        // === VERÄ° Ä°ÅLEM FONKSÄ°YONLARI ===
        const saveEntry = async () => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        window.deleteEntry = async (id) => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        window.deleteStudent = async (event, uid, name) => { /* ... Ã–nceki cevaplardaki gibi ... */ };

        // === ARAYÃœZ ve NAVÄ°GASYON ===
        const showTab = (tab) => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        window.viewStudentDetail = (uid, name) => { /* ... Ã–nceki cevaplardaki gibi ... */ };
        window.backToStudentList = () => { /* ... Ã–nceki cevaplardaki gibi ... */ };

        // === VERÄ° YÃœKLEME FONKSÄ°YONLARI ===
        async function renderEntries(containerId, entriesQuery) { /* ... */ }
        const loadEntries = () => { /* ... */ };
        const loadStudentDetailEntries = (uid) => { /* ... */ };
        async function loadAllStudents() { /* ... */ }
        
        // === Ä°STATÄ°STÄ°K FONKSÄ°YONLARI (TAM VE Ã‡ALIÅAN HALÄ°) ===
        async function loadStudentStats() {
            try {
                const container = document.getElementById('studentStatsContent');
                container.innerHTML = '<h3>Son 7 GÃ¼n - Ders BazlÄ± Ä°statistikler</h3>';
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekAgoStr = weekAgo.toISOString().split('T')[0];
                const entriesQuery = query(collection(db, 'entries'), where('uid', '==', currentUser.uid), where('date', '>=', weekAgoStr));
                const snapshot = await getDocs(entriesQuery);
                const subjectData = {};
                snapshot.forEach(docSnap => {
                    const data = docSnap.data();
                    if (!subjectData[data.subject]) subjectData[data.subject] = { solved: 0, correct: 0, wrong: 0 };
                    subjectData[data.subject].solved += data.solved;
                    subjectData[data.subject].correct += data.correct;
                    subjectData[data.subject].wrong += data.wrong;
                });
                if (Object.keys(subjectData).length === 0) {
                    container.innerHTML += '<p style="text-align:center;color:#999;padding:20px;">Son 7 gÃ¼nde veri yok</p>';
                    return;
                }
                createStudentChart(subjectData, 'studentChart', container);
            } catch (error) {
                console.error('Ã–ÄŸrenci istatistik yÃ¼kleme hatasÄ±:', error);
                document.getElementById('studentStatsContent').innerHTML = '<p style="text-align:center;color:#c33;">Ä°statistikler yÃ¼klenirken hata oluÅŸtu.</p>';
            }
        }
        async function loadCoachStats() {
            try {
                const container = document.getElementById('coachStatsContent');
                container.innerHTML = '<h3 style="margin-bottom:20px;">TÃ¼m Ã–ÄŸrenciler - Son 7 GÃ¼n Ä°statistikleri</h3>';
                const usersQuery = query(collection(db, 'users'), where('email', '!=', COACH_EMAIL));
                const usersSnapshot = await getDocs(usersQuery);
                if (usersSnapshot.empty) {
                    container.innerHTML += '<p style="text-align:center;color:#999;">HenÃ¼z Ã¶ÄŸrenci yok</p>';
                    return;
                }
                const weekAgo = new Date();
                weekAgo.setDate(weekAgo.getDate() - 7);
                const weekAgoStr = weekAgo.toISOString().split('T')[0];
                for (const userDoc of usersSnapshot.docs) {
                    const student = { uid: userDoc.id, ...userDoc.data() };
                    const entriesQuery = query(collection(db, 'entries'), where('uid', '==', student.uid), where('date', '>=', weekAgoStr));
                    const snapshot = await getDocs(entriesQuery);
                    const subjectData = {};
                    snapshot.forEach(docSnap => {
                        const data = docSnap.data();
                        if (!subjectData[data.subject]) subjectData[data.subject] = { solved: 0, correct: 0, wrong: 0 };
                        subjectData[data.subject].solved += data.solved;
                        subjectData[data.subject].correct += data.correct;
                        subjectData[data.subject].wrong += data.wrong;
                    });
                    const studentCard = document.createElement('div');
                    studentCard.className = 'stats-card';
                    studentCard.innerHTML = `<h4 style="color:#667eea;margin-bottom:15px;">${student.name}</h4>`;
                    if (Object.keys(subjectData).length === 0) {
                        studentCard.innerHTML += '<p style="color:#999;text-align:center;">Bu Ã¶ÄŸrenci son 7 gÃ¼nde veri girmemiÅŸ</p>';
                    } else {
                        const chartId = 'coachChart_' + student.uid;
                        createStudentChart(subjectData, chartId, studentCard);
                    }
                    container.appendChild(studentCard);
                }
            } catch (error) {
                console.error('KoÃ§ istatistikleri yÃ¼kleme hatasÄ±:', error);
                document.getElementById('coachStatsContent').innerHTML = '<p style="text-align:center;color:#c33;">Ä°statistikler yÃ¼klenirken hata oluÅŸtu.</p>';
            }
        }
        function createStudentChart(subjectData, canvasId, container) {
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();
            const existingCanvas = document.getElementById(canvasId);
            if(existingCanvas) existingCanvas.parentElement.remove();
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = `<canvas id="${canvasId}"></canvas>`;
            container.appendChild(chartDiv);
            const subjects = Object.keys(subjectData);
            const ctx = document.getElementById(canvasId).getContext('2d');
            chartInstances[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: subjects,
                    datasets: [
                        { label: 'Toplam Soru', data: subjects.map(s => subjectData[s].solved), backgroundColor: subjects.map(s => SUBJECT_COLORS[s] || '#6b7280') },
                        { label: 'DoÄŸru', data: subjects.map(s => subjectData[s].correct), backgroundColor: '#10b981' },
                        { label: 'YanlÄ±ÅŸ', data: subjects.map(s => subjectData[s].wrong), backgroundColor: '#ef4444' }
                    ]
                },
                options: { responsive: true, plugins: { legend: { position: 'bottom' } }, scales: { y: { beginAtZero: true } } }
            });
        }
        
        // === ANA OTURUM KONTROLÃœ ===
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isCoach = user.email === COACH_EMAIL;
                try {
                    const userDocRef = doc(db, 'users', user.uid);
                    const userDocSnap = await getDoc(userDocRef);
                    if (!userDocSnap.exists()) throw new Error("KullanÄ±cÄ± veritabanÄ±nda bulunamadÄ±.");
                    const userData = userDocSnap.data();
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('studentTabs').style.display = isCoach ? 'none' : 'block';
                    document.getElementById('coachTabs').style.display = isCoach ? 'block' : 'none';
                    if (isCoach) {
                        showTab('stats');
                    } else {
                        showTab('entry');
                        loadEntries();
                    }
                    document.getElementById('authSection').classList.remove('active');
                    document.getElementById('appSection').classList.add('active');
                } catch (error) {
                    console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', error);
                    showAuthMessage('Oturum aÃ§Ä±lÄ±rken bir hata oluÅŸtu, lÃ¼tfen tekrar giriÅŸ yapÄ±n', 'error');
                    await fbSignOut(auth);
                }
            } else {
                currentUser = null;
                isCoach = false;
                document.getElementById('authSection').classList.add('active');
                document.getElementById('appSection').classList.remove('active');
            }
        });
        
        // === EVENT LISTENERS (Sayfa YÃ¼klendiÄŸinde Ã‡alÄ±ÅŸÄ±r) ===
        document.addEventListener('DOMContentLoaded', () => {
            // ... (Butonlara event listener atamalarÄ±)
        });

    </script>
</body>
</html>
Ã–nemli Not: Firestore GÃ¼venlik KurallarÄ±
Bu kodun hatasÄ±z Ã§alÄ±ÅŸmasÄ± iÃ§in, Firestore veritabanÄ±nÄ±zdaki Kurallar sekmesinde aÅŸaÄŸÄ±daki kurallarÄ±n kayÄ±tlÄ± olduÄŸundan emin olun. Bu, en son konuÅŸtuÄŸumuz ve tÃ¼m yetkileri (koÃ§un silme yetkisi vb.) doÄŸru ÅŸekilde ayarlayan versiyondur.

JavaScript

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // "users" Koleksiyonu KurallarÄ±
    match /users/{userId} {
      allow read: if request.auth.uid == userId || request.auth.token.email == "abdussametkrkmz@gmail.com";
      allow create, update: if request.auth.uid == userId;
      allow delete: if request.auth.token.email == "abdussametkrkmz@gmail.com";
    }

    // "entries" Koleksiyonu KurallarÄ±
    match /entries/{entryId} {
      allow read: if resource.data.uid == request.auth.uid || request.auth.token.email == "abdussametkrkmz@gmail.com";
      allow create: if request.resource.data.uid == request.auth.uid;
      allow update, delete: if resource.data.uid == request.auth.uid || request.auth.token.email == "abdussametkrkmz@gmail.com";
    }
  }
}
