
<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Takip Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            max-width: 900px; margin: 0 auto; background: white;
            border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        h1 { color: #667eea; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .auth-section, .app-section { display: none; }
        .auth-section.active, .app-section.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input, select {
            width: 100%; padding: 12px; border: 2px solid #e0e0e0;
            border-radius: 10px; font-size: 16px; transition: border-color 0.3s;
        }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button {
            width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; border: none; border-radius: 10px; font-size: 16px;
            font-weight: 600; cursor: pointer; transition: transform 0.2s;
        }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; }
        .btn-danger { background: #ef4444; }
        .btn-success { background: #10b981; }
        .btn-small {
            padding: 8px 16px; font-size: 13px; width: auto;
            display: inline-block; margin: 5px;
        }
        .user-info {
            background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;
            display: flex; justify-content: space-between; align-items: center;
        }
        .tabs, .sub-tabs { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tab, .sub-tab {
            flex: 1; min-width: 100px; padding: 12px; background: #f0f0f0;
            border: none; border-radius: 10px; cursor: pointer;
            font-weight: 600; font-size: 14px;
        }
        .tab.active, .sub-tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .sub-tabs { margin-top: 20px; }
        .card {
            background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px;
            border: 2px solid #e0e0e0; transition: all 0.3s;
        }
        .card:hover { border-color: #667eea; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .card-title {
            font-weight: 600; color: #667eea; margin-bottom: 10px;
            font-size: 18px; display: flex; justify-content: space-between; align-items: center;
        }
        .clickable-title {
            cursor: pointer;
            transition: color 0.2s;
        }
        .clickable-title:hover {
            color: #764ba2;
        }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error { background: #fee; color: #c33; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .success { background: #efe; color: #3c3; padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .role-badge {
            display: inline-block; padding: 4px 10px; border-radius: 15px;
            font-size: 11px; font-weight: 600; margin-left: 10px;
        }
        .role-admin { background: #ef4444; color: white; }
        .role-coach { background: #10b981; color: white; }
        .role-student { background: #3b82f6; color: white; }
        .role-pending { background: #f59e0b; color: white; }
        .stats-info {
            display: flex; gap: 15px; font-size: 14px;
            color: #666; flex-wrap: wrap; margin-top: 10px;
        }
        .chart-container { margin-top: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section active" id="authSection">
		<h3 style="text-align: center; font-weight: 600; color: #4a5568; margin-bottom: 25px; font-size: 16px; letter-spacing: 0.5px;">
                MEHMET CANAN Ã–ZYAÅAR ANADOLU LÄ°SESÄ°
            </h3>
            <h1>ğŸ“š Soru Takip Sistemi</h1>
            <p class="subtitle">GÃ¼nlÃ¼k soru Ã§Ã¶zÃ¼m takibinizi yapÄ±n</p>
            <div id="authMessage"></div>
            <div class="input-group">
                <label>E-posta</label>
                <input type="email" id="emailInput" placeholder="ornek@email.com">
            </div>
            <div class="input-group">
                <label>Åifre</label>
                <input type="password" id="passwordInput" placeholder="En az 6 karakter">
            </div>
            <div class="input-group" id="nameGroup" style="display:none;">
                <label>Ad Soyad</label>
                <input type="text" id="nameInput" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z">
            </div>
            <div class="input-group" id="coachGroup" style="display:none;">
                <label style="display: flex; align-items: center; cursor: pointer;">
                    <input type="checkbox" id="isCoachCheckbox" style="width: auto; margin-right: 10px;">
                    <span>Ã–ÄŸretmen (KoÃ§) olarak kayÄ±t olmak istiyorum</span>
                </label>
            </div>
            <div class="input-group" id="selectCoachGroup" style="display:none;">
                <label>KoÃ§unuzu SeÃ§in</label>
                <select id="coachSelect">
                    <option value="">KoÃ§ seÃ§in...</option>
                </select>
            </div>
            <button id="signUpBtn" style="display:none;">KayÄ±t Ol</button>
            <button id="signInBtn">GiriÅŸ Yap</button>
            <button class="btn-secondary" id="toggleModeBtn">HesabÄ±m yok, kayÄ±t ol</button>
        </div>

        <div class="app-section" id="appSection">
            <div id="appMessage"></div>
            <div class="user-info">
                <div>
                    <strong id="userName">KullanÄ±cÄ±</strong>
                    <span id="userRole"></span>
                    <div style="font-size: 12px; color: #666;" id="userEmail"></div>
                </div>
                <button class="btn-small btn-secondary" id="logoutBtn">Ã‡Ä±kÄ±ÅŸ</button>
            </div>
            <div id="tabsContainer"></div>
            <div id="contentContainer"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, updateDoc, Timestamp, writeBatch } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const firebaseConfig = {
            apiKey: "AIzaSyDz0lFClcTpySHPCZnLEyXWHeQzd9RyH58",
            authDomain: "mcoalogrencikocluk.firebaseapp.com",
            projectId: "mcoalogrencikocluk",
            storageBucket: "mcoalogrencikocluk.firebasestorage.app",
            messagingSenderId: "950814379359",
            appId: "1:950814379359:web:970b00931d5e0763bdbaea"
        };

        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let userData = null;
        let isSignUpMode = false;
        let chartInstance = null;
        const ADMIN_EMAIL = "abdussametkrkmz@gmail.com";

        
        const authSection = document.getElementById('authSection');
        const appSection = document.getElementById('appSection');
        const emailInput = document.getElementById('emailInput');
        const passwordInput = document.getElementById('passwordInput');
        const nameInput = document.getElementById('nameInput');
        const isCoachCheckbox = document.getElementById('isCoachCheckbox');
        const coachSelect = document.getElementById('coachSelect');
        const signUpBtn = document.getElementById('signUpBtn');
        const signInBtn = document.getElementById('signInBtn');
        const toggleModeBtn = document.getElementById('toggleModeBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const tabsContainer = document.getElementById('tabsContainer');
        const contentContainer = document.getElementById('contentContainer');

        
        signUpBtn.addEventListener('click', handleSignUp);
        signInBtn.addEventListener('click', handleSignIn);
        toggleModeBtn.addEventListener('click', toggleAuthMode);
        logoutBtn.addEventListener('click', handleSignOut);
        isCoachCheckbox.addEventListener('change', handleCoachCheckboxChange);

        function toggleAuthMode() {
            isSignUpMode = !isSignUpMode;
            document.getElementById('nameGroup').style.display = isSignUpMode ? 'block' : 'none';
            document.getElementById('coachGroup').style.display = isSignUpMode ? 'block' : 'none';
            signUpBtn.style.display = isSignUpMode ? 'block' : 'none';
            signInBtn.style.display = isSignUpMode ? 'none' : 'block';
            toggleModeBtn.textContent = isSignUpMode ? 'Zaten hesabÄ±m var, giriÅŸ yap' : 'HesabÄ±m yok, kayÄ±t ol';
            if (isSignUpMode) {
                loadApprovedCoaches();
                handleCoachCheckboxChange();
            } else {
                 document.getElementById('selectCoachGroup').style.display = 'none';
            }
        }

        function handleCoachCheckboxChange() {
            const isCoach = isCoachCheckbox.checked;
            document.getElementById('selectCoachGroup').style.display = isSignUpMode && !isCoach ? 'block' : 'none';
        }

        async function loadApprovedCoaches() {
            try {
                const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', true));
                const snapshot = await getDocs(q);
                coachSelect.innerHTML = '<option value="">KoÃ§ seÃ§in...</option>';
                snapshot.forEach(docSnap => {
                    const coach = docSnap.data();
                    const option = document.createElement('option');
                    option.value = coach.uid;
                    option.textContent = coach.name;
                    coachSelect.appendChild(option);
                });
            } catch (error) {
                showMessage('KoÃ§lar yÃ¼klenemedi: ' + error.message, 'error', 'auth');
            }
        }

        async function handleSignUp() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            const name = nameInput.value.trim();
            const isCoach = isCoachCheckbox.checked;
            const selectedCoach = coachSelect.value;
            if (!email || !password || !name) { showMessage('LÃ¼tfen tÃ¼m alanlarÄ± doldurun', 'error', 'auth'); return; }
            if (!isCoach && !selectedCoach) { showMessage('LÃ¼tfen bir koÃ§ seÃ§in', 'error', 'auth'); return; }
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await addDoc(collection(db, 'users'), {
                    uid: userCredential.user.uid, email: email, name: name,
                    role: isCoach ? 'coach' : 'student',
                    approved: isCoach ? false : true,
                    coachId: isCoach ? null : selectedCoach,
                    createdAt: Timestamp.now()
                });
                showMessage(isCoach ? 'KayÄ±t baÅŸarÄ±lÄ±! HesabÄ±nÄ±zÄ±n yÃ¶netici tarafÄ±ndan onaylanmasÄ± gerekiyor.' : 'KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapabilirsiniz.', 'success', 'auth');
                toggleAuthMode();
            } catch (error) { showMessage('KayÄ±t hatasÄ±: ' + error.message, 'error', 'auth'); }
        }

        async function handleSignIn() {
            const email = emailInput.value.trim();
            const password = passwordInput.value;
            if (!email || !password) { showMessage('LÃ¼tfen e-posta ve ÅŸifre girin', 'error', 'auth'); return; }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) { showMessage('GiriÅŸ baÅŸarÄ±sÄ±z: ' + error.message, 'error', 'auth'); }
        }

        async function handleSignOut() {
            try { await fbSignOut(auth); window.location.reload(); }
            catch (error) { showMessage('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±', 'error', 'app'); }
        }

        function showMessage(msg, type, section) {
            const messageDiv = section === 'auth' ? document.getElementById('authMessage') : document.getElementById('appMessage');
            messageDiv.className = type;
            messageDiv.textContent = msg;
            setTimeout(() => { if (messageDiv.textContent === msg) { messageDiv.textContent = ''; } }, 5000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                const q = query(collection(db, 'users'), where('uid', '==', user.uid));
                const snapshot = await getDocs(q);
                if (snapshot.empty) { showMessage('KullanÄ±cÄ± veritabanÄ±nda bulunamadÄ±', 'error', 'app'); await fbSignOut(auth); return; }
                userData = snapshot.docs[0].data();
                userData.docId = snapshot.docs[0].id;
                if (user.email === ADMIN_EMAIL) { userData.role = 'admin'; userData.approved = true; }
                if (userData.role === 'coach' && !userData.approved) { alert('HesabÄ±nÄ±z henÃ¼z yÃ¶netici tarafÄ±ndan onaylanmadÄ±.'); await fbSignOut(auth); return; }
                document.getElementById('userName').textContent = userData.name;
                document.getElementById('userEmail').textContent = user.email;
                let roleText = '', roleClass = '';
                if (userData.role === 'admin') { roleText = 'ADMÄ°N'; roleClass = 'role-admin'; }
                else if (userData.role === 'coach') { roleText = 'KOÃ‡'; roleClass = 'role-coach'; }
                else { roleText = 'Ã–ÄRENCÄ°'; roleClass = 'role-student'; }
                document.getElementById('userRole').innerHTML = `<span class="role-badge ${roleClass}">${roleText}</span>`;
                authSection.classList.remove('active');
                appSection.classList.add('active');
                loadUserInterface();
            } else {
                currentUser = null; userData = null;
                authSection.classList.add('active');
                appSection.classList.remove('active');
            }
        });

        function loadUserInterface() {
            if (userData.role === 'admin') loadAdminInterface();
            else if (userData.role === 'coach') loadCoachInterface();
            else loadStudentInterface();
        }

        function setupTabEvents(callback, selector = '.tab') {
            document.querySelectorAll(selector).forEach(tab => {
                tab.addEventListener('click', (e) => {
                    document.querySelectorAll(selector).forEach(t => t.classList.remove('active'));
                    e.target.classList.add('active');
                    callback(e.target.dataset.tab);
                });
            });
        }

        function loadAdminInterface() {
            tabsContainer.innerHTML = `
                <div class="tabs">
                    <button class="tab active" data-tab="mystudents">Ã–ÄŸrencilerim</button>
                    <button class="tab" data-tab="mystats">HaftalÄ±k Ä°statistikler</button>
                    <button class="tab" data-tab="allcoaches">TÃ¼m KoÃ§lar</button>
                    <button class="tab" data-tab="pending">Onay Bekleyenler</button>
                </div>`;
            setupTabEvents(showAdminTab);
            showAdminTab('mystudents');
        }

        async function showAdminTab(tabName) {
            contentContainer.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
            if (tabName === 'mystudents') await loadMyStudents();
            else if (tabName === 'mystats') await loadCoachStats(currentUser.uid, contentContainer);
            else if (tabName === 'allcoaches') await window.loadAllCoaches();
            else if (tabName === 'pending') await loadPendingCoaches();
        }
        
        function loadCoachInterface() {
            tabsContainer.innerHTML = `
                <div class="tabs">
                    <button class="tab active" data-tab="mystudents">Ã–ÄŸrencilerim</button>
                    <button class="tab" data-tab="mystats">HaftalÄ±k Ä°statistikler</button>
                </div>`;
            setupTabEvents(showCoachTab);
            showCoachTab('mystudents');
        }

        async function showCoachTab(tabName) {
            if (tabName === 'mystudents') await loadMyStudents();
            else if (tabName === 'mystats') await loadCoachStats(currentUser.uid, contentContainer);
        }



        function loadStudentInterface() {
            tabsContainer.innerHTML = `<div class="tabs"><button class="tab active" data-tab="entry">Veri Gir</button><button class="tab" data-tab="mystats">Ä°statistiklerim</button></div>`;
            setupTabEvents(showStudentTab);
            showStudentTab('entry');
        }

        async function showStudentTab(tabName) {
            contentContainer.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
            if (tabName === 'entry') loadEntryForm();
            else if (tabName === 'mystats') await loadMyStats();
        }

        function loadEntryForm() {
            contentContainer.innerHTML = `
                <div class="input-group"><label>Ders</label><select id="subjectInput">
                    <option value="">Ders seÃ§in</option><option value="TÃ¼rkÃ§e">TÃ¼rkÃ§e</option><option value="Matematik">Matematik</option><option value="Fizik">Fizik</option><option value="Kimya">Kimya</option><option value="Biyoloji">Biyoloji</option><option value="Tarih">Tarih</option><option value="CoÄŸrafya">CoÄŸrafya</option><option value="Din KÃ¼ltÃ¼rÃ¼">Din KÃ¼ltÃ¼rÃ¼</option><option value="Felsefe">Felsefe</option><option value="Deneme SÄ±navÄ±">Deneme SÄ±navÄ±</option>
                </select></div>
                <div class="input-group"><label>Tarih</label><input type="date" id="dateInput"></div>
                <div class="input-group"><label>Ã‡Ã¶zÃ¼len Soru</label><input type="number" id="solvedInput" min="0" placeholder="0"></div>
                <div class="input-group"><label>DoÄŸru</label><input type="number" id="correctInput" min="0" placeholder="0"></div>
                <div class="input-group"><label>YanlÄ±ÅŸ</label><input type="number" id="wrongInput" min="0" placeholder="0"></div>
                <button id="saveEntryBtn">Kaydet</button>
                <div id="entriesList" style="margin-top: 30px;"></div>
            `;
            document.getElementById('dateInput').valueAsDate = new Date();
            document.getElementById('saveEntryBtn').addEventListener('click', saveEntry);
            loadMyEntries();
        }

        async function saveEntry() {
            const subject = document.getElementById('subjectInput').value;
            const date = document.getElementById('dateInput').value;
            const solved = parseInt(document.getElementById('solvedInput').value) || 0;
            const correct = parseInt(document.getElementById('correctInput').value) || 0;
            const wrong = parseInt(document.getElementById('wrongInput').value) || 0;

            if (!subject || !date || solved === 0) { showMessage('LÃ¼tfen tÃ¼m alanlarÄ± eksiksiz doldurun.', 'error', 'app'); return; }
            if(correct + wrong > solved) { showMessage('DoÄŸru ve yanlÄ±ÅŸ sayÄ±sÄ± toplamÄ±, Ã§Ã¶zÃ¼len soru sayÄ±sÄ±ndan fazla olamaz.', 'error', 'app'); return; }

            try {
                await addDoc(collection(db, 'entries'), {
                    uid: currentUser.uid, subject, date, solved, correct, wrong,
                    createdAt: Timestamp.now()
                });
                loadEntryForm();
                showMessage('KayÄ±t eklendi!', 'success', 'app');
            } catch (error) { showMessage('Hata: ' + error.message, 'error', 'app'); }
        }

        async function loadMyEntries() {
            const entriesList = document.getElementById('entriesList');
            if (!entriesList) return;
            entriesList.innerHTML = '<div class="loading">KayÄ±tlar yÃ¼kleniyor...</div>';
            const q = query(collection(db, 'entries'), where('uid', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            
            if (snapshot.empty) {
                entriesList.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">HenÃ¼z kayÄ±t yok</p>'; return;
            }

            let entries = [];
            snapshot.forEach(doc => entries.push({ id: doc.id, ...doc.data() }));
            entries.sort((a, b) => b.createdAt.toMillis() - a.createdAt.toMillis());

            let html = '<h3 style="margin-bottom: 15px;">Son KayÄ±tlarÄ±m</h3>';
            entries.forEach(entry => {
                html += `
                    <div class="card">
                        <div style="display:flex;justify-content:space-between;align-items:center;">
                            <div>
                                <strong>${entry.date}</strong>
                                <span style="margin-left:10px;background:#667eea;color:white;padding:4px 10px;border-radius:15px;font-size:12px;">${entry.subject}</span>
                            </div>
                            <button class="btn-small btn-danger" onclick="window.deleteEntry('${entry.id}')">Sil</button>
                        </div>
                        <div class="stats-info">
                            <span>ğŸ“ ${entry.solved} soru</span><span>âœ… ${entry.correct} doÄŸru</span><span>âŒ ${entry.wrong} yanlÄ±ÅŸ</span>
                        </div>
                    </div>
                `;
            });
            entriesList.innerHTML = html;
        }

        async function loadMyStats() {
            contentContainer.innerHTML = '<h3>Ä°statistiklerim</h3><div class="loading">YÃ¼kleniyor...</div>';
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            const weeklyQuery = query(collection(db, 'entries'), where('uid', '==', currentUser.uid), where('date', '>=', sevenDaysAgoStr));
            const weeklySnapshot = await getDocs(weeklyQuery);
            const allQuery = query(collection(db, 'entries'), where('uid', '==', currentUser.uid));
            const allSnapshot = await getDocs(allQuery);

            let total = 0, correct = 0, wrong = 0;
            const subjectData = {};
            const weeklySubjectData = {};

            allSnapshot.forEach(doc => {
                const data = doc.data();
                total += data.solved || 0;
                correct += data.correct || 0;
                wrong += data.wrong || 0;
                if (!subjectData[data.subject]) { subjectData[data.subject] = { solved: 0 }; }
                subjectData[data.subject].solved += data.solved;
            });

            weeklySnapshot.forEach(doc => {
                const data = doc.data();
                if (!weeklySubjectData[data.subject]) {
                    weeklySubjectData[data.subject] = { solved: 0, correct: 0, wrong: 0 };
                }
                weeklySubjectData[data.subject].solved += data.solved;
                weeklySubjectData[data.subject].correct += data.correct;
                weeklySubjectData[data.subject].wrong += data.wrong;
            });

            const previousStats = await getPreviousWeekStats(currentUser.uid);
            let weeklyHtml = '';
            for (const subject in weeklySubjectData) {
                const stats = weeklySubjectData[subject];
                const successRate = stats.solved > 0 ? Math.round((stats.correct/stats.solved)*100) : 0;
                const prevRate = previousStats[subject] || 0;
                const improvement = successRate - prevRate;
                let improvementText = '';
                if (prevRate > 0) {
                    if (improvement > 0) {
                        improvementText = `<div style="color: #10b981; font-size: 13px; margin-top: 5px;">ğŸ‰ Harika! GeÃ§en haftaya gÃ¶re %${improvement} daha iyi! Devam et!</div>`;
                    } else if (improvement < 0) {
                        improvementText = `<div style="color: #f59e0b; font-size: 13px; margin-top: 5px;">ğŸ’ª GeÃ§en haftaya gÃ¶re %${Math.abs(improvement)} dÃ¼ÅŸÃ¼ÅŸ. Biraz daha Ã§aba gÃ¶ster, baÅŸarabilirsin!</div>`;
                    } else {
                        improvementText = `<div style="color: #3b82f6; font-size: 13px; margin-top: 5px;">ğŸ¯ Stabil performans! Bir sonraki hafta daha iyisini yapabilirsin!</div>`;
                    }
                }
                weeklyHtml += `
                    <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                        <strong style="color: #667eea;">${subject}</strong>
                        <div class="stats-info" style="margin-top: 5px;">
                            <span>ğŸ“ Soru: ${stats.solved}</span>
                            <span>âœ… DoÄŸru: ${stats.correct}</span>
                            <span>âŒ YanlÄ±ÅŸ: ${stats.wrong}</span>
                            <span>ğŸ¯ BaÅŸarÄ±: %${successRate}</span>
                        </div>
                        ${improvementText}
                    </div>`;
            }

            let html = `
                <div class="card"><h3>Genel Toplam</h3><div class="stats-info" style="margin-top:15px;">
                    <span>ğŸ“ ${total} soru</span><span>âœ… ${correct} doÄŸru</span><span>âŒ ${wrong} yanlÄ±ÅŸ</span>
                    <span>ğŸ¯ ${total > 0 ? Math.round((correct/total)*100) : 0}% baÅŸarÄ±</span>
                </div></div>
                <div class="card"><h3>Son 1 HaftalÄ±k Performans</h3>${weeklyHtml || '<p style="color:#999;padding:10px;">Son 1 haftada veri yok</p>'}</div>
                <div class="card"><h3>Derslere GÃ¶re Soru DaÄŸÄ±lÄ±mÄ±</h3>
                    <div class="chart-container"><canvas id="myStatsChart"></canvas></div>
                </div>
            `;
            contentContainer.innerHTML = html;
            
            if(Object.keys(subjectData).length > 0) { createChart('myStatsChart', subjectData); }
            
            const statsToSave = {};
            for (const subject in weeklySubjectData) {
                const subData = weeklySubjectData[subject];
                statsToSave[subject] = subData.solved > 0 ? Math.round((subData.correct/subData.solved)*100) : 0;
            }
            const q = query(collection(db, 'weeklyStats'), where('uid', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) {
                await addDoc(collection(db, 'weeklyStats'), { uid: currentUser.uid, stats: statsToSave, updatedAt: Timestamp.now() });
            } else {
                await updateDoc(doc(db, 'weeklyStats', snapshot.docs[0].id), { stats: statsToSave, updatedAt: Timestamp.now() });
            }
        }
        
        function createChart(canvasId, subjectData) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (chartInstance) { chartInstance.destroy(); }
            
            const labels = Object.keys(subjectData);
            const data = labels.map(label => subjectData[label].solved);

            chartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: labels, datasets: [{
                    label: 'Ã‡Ã¶zÃ¼len Soru SayÄ±sÄ±', data: data,
                    backgroundColor: ['rgba(255, 99, 132, 0.5)','rgba(54, 162, 235, 0.5)','rgba(255, 206, 86, 0.5)','rgba(75, 192, 192, 0.5)','rgba(153, 102, 255, 0.5)','rgba(255, 159, 64, 0.5)'],
                    borderColor: ['rgba(255, 99, 132, 1)','rgba(54, 162, 235, 1)','rgba(255, 206, 86, 1)','rgba(75, 192, 192, 1)','rgba(153, 102, 255, 1)','rgba(255, 159, 64, 1)'],
                    borderWidth: 1
                }]},
                options: { scales: { y: { beginAtZero: true } } }
            });
        }

        async function loadMyStudents() {
            contentContainer.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
            const q = query(collection(db, 'users'), where('coachId', '==', currentUser.uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>Ã–ÄŸrencilerim</h3><p style="text-align:center;color:#999;padding:20px;">HenÃ¼z Ã¶ÄŸrenciniz yok.</p>'; return; }
            let html = '<h3>Ã–ÄŸrencilerim</h3>';
            for (const docSnap of snapshot.docs) {
                const student = docSnap.data();
                const stats = await getStudentStats(student.uid);
                html += `
                    <div class="card">
                        <div class="card-title">${student.name}<button class="btn-small btn-danger" onclick="window.deleteStudent('${docSnap.id}', '${student.name}', '${student.uid}')">Ã–ÄŸrenciyi Sil</button></div>
                        <div style="font-size: 13px; color: #999;">${student.email}</div>
                        <div class="stats-info">
                            <span>ğŸ“ ${stats.total} soru</span><span>âœ… ${stats.correct} doÄŸru</span><span>âŒ ${stats.wrong} yanlÄ±ÅŸ</span>
                            <span>ğŸ¯ ${stats.total > 0 ? Math.round((stats.correct/stats.total)*100) : 0}% baÅŸarÄ±</span>
                        </div>
                    </div>`;
            }
            contentContainer.innerHTML = html;
        }
        
        window.loadAllCoaches = async function() {
            contentContainer.innerHTML = '<h3>TÃ¼m KoÃ§lar</h3><div class="loading">YÃ¼kleniyor...</div>';
            const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', true));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>TÃ¼m KoÃ§lar</h3><p style="text-align:center;color:#999;padding:20px;">Sistemde onaylÄ± koÃ§ bulunmuyor.</p>'; return; }
            let html = '<h3>TÃ¼m KoÃ§lar</h3>';
            for (const docSnap of snapshot.docs) {
                const coach = docSnap.data();
                const studentCount = await getCoachStudentCount(coach.uid);
                html += `
                    <div class="card">
                        <div class="card-title">
                            <span class="clickable-title" onclick="window.showCoachDetailView('${coach.uid}', '${coach.name}')">${coach.name}</span>
                            ${coach.email !== ADMIN_EMAIL ? `<button class="btn-small btn-danger" onclick="window.deleteCoach('${docSnap.id}', '${coach.name}')">KoÃ§u Sil</button>` : ''}
                        </div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 10px;">${coach.email}</div>
                        <div class="stats-info"><span>ğŸ‘¥ ${studentCount} Ã¶ÄŸrenci</span></div>
                    </div>`;
            }
            contentContainer.innerHTML = html;
        }

        async function loadPendingCoaches() {
            contentContainer.innerHTML = '<h3>Onay Bekleyen KoÃ§lar</h3><div class="loading">YÃ¼kleniyor...</div>';
            const q = query(collection(db, 'users'), where('role', '==', 'coach'), where('approved', '==', false));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { contentContainer.innerHTML = '<h3>Onay Bekleyen KoÃ§lar</h3><p style="text-align:center;color:#999;padding:20px;">Onay bekleyen koÃ§ yok.</p>'; return; }
            let html = '<h3>Onay Bekleyen KoÃ§lar</h3>';
            snapshot.forEach(docSnap => {
                const coach = docSnap.data();
                html += `
                    <div class="card">
                        <div class="card-title">${coach.name} <span class="role-badge role-pending">ONAY BEKLÄ°YOR</span></div>
                        <div style="font-size: 13px; color: #999; margin-bottom: 10px;">${coach.email}</div>
                        <button class="btn-small btn-success" onclick="window.approveCoach('${docSnap.id}', '${coach.name}')">Onayla</button>
                        <button class="btn-small btn-danger" onclick="window.rejectCoach('${docSnap.id}', '${coach.name}')">Reddet</button>
                    </div>`;
            });
            contentContainer.innerHTML = html;
        }
        


        async function getStudentStats(uid) {
            const q = query(collection(db, 'entries'), where('uid', '==', uid));
            const snapshot = await getDocs(q);
            let total = 0, correct = 0, wrong = 0;
            snapshot.forEach(doc => {
                const data = doc.data();
                total += data.solved || 0;
                correct += data.correct || 0;
                wrong += data.wrong || 0;
            });
            return { total, correct, wrong };
        }

        async function getCoachStudentCount(coachId) {
            const q = query(collection(db, 'users'), where('coachId', '==', coachId));
            const snapshot = await getDocs(q);
            return snapshot.size;
        }

        window.deleteEntry = async function(entryId) {
            if (!confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) return;
            try { await deleteDoc(doc(db, 'entries', entryId)); showMessage('KayÄ±t silindi.', 'success', 'app'); loadMyEntries(); }
            catch (error) { showMessage('Silme hatasÄ±: ' + error.message, 'error', 'app'); }
        };

        window.approveCoach = async function(docId, name) {
            if (!confirm(`'${name}' adlÄ± Ã¶ÄŸretmeni onaylÄ±yor musunuz?`)) return;
            try { await updateDoc(doc(db, 'users', docId), { approved: true }); showMessage('KoÃ§ onaylandÄ±.', 'success', 'app'); loadPendingCoaches(); }
            catch (error) { showMessage('Onaylama hatasÄ±: ' + error.message, 'error', 'app'); }
        };

        window.rejectCoach = async function(docId, name) {
            if (!confirm(`'${name}' adlÄ± Ã¶ÄŸretmeni reddetmek istediÄŸinizden emin misiniz? Bu iÅŸlem kullanÄ±cÄ±nÄ±n kaydÄ±nÄ± silecektir.`)) return;
            try { await deleteDoc(doc(db, 'users', docId)); showMessage('KoÃ§ kaydÄ± reddedildi ve silindi.', 'success', 'app'); loadPendingCoaches(); }
            catch (error) { showMessage('Reddetme hatasÄ±: ' + error.message, 'error', 'app'); }
        };

        window.deleteCoach = async function(docId, name) {
            if (!confirm(`DÄ°KKAT! '${name}' adlÄ± koÃ§u silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz. Bu koÃ§a baÄŸlÄ± Ã¶ÄŸrenciler sahipsiz kalacaktÄ±r. Devam edilsin mi?`)) return;
            try { await deleteDoc(doc(db, 'users', docId)); showMessage('KoÃ§ silindi.', 'success', 'app'); window.loadAllCoaches(); }
            catch (error) { showMessage('Silme hatasÄ±: ' + error.message, 'error', 'app'); }
        }

        window.deleteStudent = async function(docId, name, studentUid) {
            if (!confirm(`DÄ°KKAT! '${name}' adlÄ± Ã¶ÄŸrenciyi ve Ã¶ÄŸrenciye ait TÃœM soru kayÄ±tlarÄ±nÄ± kalÄ±cÄ± olarak silmek istediÄŸinizden emin misiniz?`)) return;
            try {
                const batch = writeBatch(db);
                const entriesQuery = query(collection(db, 'entries'), where('uid', '==', studentUid));
                const entriesSnapshot = await getDocs(entriesQuery);
                entriesSnapshot.forEach(doc => { batch.delete(doc.ref); });
                const userDocRef = doc(db, 'users', docId);
                batch.delete(userDocRef);
                await batch.commit();
                showMessage('Ã–ÄŸrenci ve tÃ¼m verileri silindi.', 'success', 'app');
                loadMyStudents();
            } catch (error) { showMessage('Ã–ÄŸrenci silme hatasÄ±: ' + error.message, 'error', 'app'); }
        };

        async function loadCoachStats(coachUid, container) {
            container.innerHTML = '<div class="loading">Ä°statistikler hesaplanÄ±yor...</div>';
            const studentQuery = query(collection(db, 'users'), where('coachId', '==', coachUid));
            const studentSnapshot = await getDocs(studentQuery);
            if (studentSnapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Ä°statistik gÃ¶sterecek Ã¶ÄŸrenci bulunmuyor.</p>'; return; }
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            const sevenDaysAgoStr = sevenDaysAgo.toISOString().split('T')[0];
            const studentStats = {};
            for (const studentDoc of studentSnapshot.docs) {
                const student = studentDoc.data();
                const entriesQuery = query(collection(db, 'entries'), where('uid', '==', student.uid), where('date', '>=', sevenDaysAgoStr));
                const entriesSnapshot = await getDocs(entriesQuery);
                if (!entriesSnapshot.empty) {
                    studentStats[student.name] = { uid: student.uid, subjects: {} };
                    entriesSnapshot.forEach(doc => {
                        const entry = doc.data();
                        if (!studentStats[student.name].subjects[entry.subject]) {
                            studentStats[student.name].subjects[entry.subject] = { solved: 0, correct: 0, wrong: 0 };
                        }
                        studentStats[student.name].subjects[entry.subject].solved += entry.solved;
                        studentStats[student.name].subjects[entry.subject].correct += entry.correct;
                        studentStats[student.name].subjects[entry.subject].wrong += entry.wrong;
                    });
                }
            }
            if (Object.keys(studentStats).length === 0) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Ã–ÄŸrencileriniz son 1 hafta iÃ§inde hiÃ§ soru giriÅŸi yapmamÄ±ÅŸ.</p>'; return; }
            let html = '<h4>Son 1 HaftalÄ±k Ã–ÄŸrenci PerformansÄ±</h4>';
            for (const studentName in studentStats) {
                html += `<div class="card"><div class="card-title">${studentName}</div>`;
                const previousStats = await getPreviousWeekStats(studentStats[studentName].uid);
                for (const subject in studentStats[studentName].subjects) {
                    const stats = studentStats[studentName].subjects[subject];
                    const successRate = stats.solved > 0 ? Math.round((stats.correct/stats.solved)*100) : 0;
                    const prevRate = previousStats[subject] || 0;
                    const improvement = successRate - prevRate;
                    let improvementText = '';
                    if (prevRate > 0) {
                        if (improvement > 0) {
                            improvementText = `<div style="color: #10b981; font-size: 13px; margin-top: 5px;">ğŸ‰ Harika! GeÃ§en haftaya gÃ¶re %${improvement} daha iyi! Devam et!</div>`;
                        } else if (improvement < 0) {
                            improvementText = `<div style="color: #f59e0b; font-size: 13px; margin-top: 5px;">ğŸ’ª GeÃ§en haftaya gÃ¶re %${Math.abs(improvement)} dÃ¼ÅŸÃ¼ÅŸ. Biraz daha Ã§aba gÃ¶ster, baÅŸarabilirsin!</div>`;
                        } else {
                            improvementText = `<div style="color: #3b82f6; font-size: 13px; margin-top: 5px;">ğŸ¯ Stabil performans! Bir sonraki hafta daha iyisini yapabilirsin!</div>`;
                        }
                    }
                    html += `
                        <div style="margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <strong style="color: #667eea;">${subject}</strong>
                            <div class="stats-info" style="margin-top: 5px;">
                                <span>ğŸ“ Soru: ${stats.solved}</span>
                                <span>âœ… DoÄŸru: ${stats.correct}</span>
                                <span>âŒ YanlÄ±ÅŸ: ${stats.wrong}</span>
                                <span>ğŸ¯ BaÅŸarÄ±: %${successRate}</span>
                            </div>
                            ${improvementText}
                        </div>`;
                }
                html += '</div>';
            }
            container.innerHTML = html;
            await saveWeeklyStats(studentStats);
        }

        async function getPreviousWeekStats(uid) {
            const q = query(collection(db, 'weeklyStats'), where('uid', '==', uid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) return {};
            const data = snapshot.docs[0].data();
            return data.stats || {};
        }

        async function saveWeeklyStats(studentStats) {
            for (const studentName in studentStats) {
                const uid = studentStats[studentName].uid;
                const stats = {};
                for (const subject in studentStats[studentName].subjects) {
                    const subjectData = studentStats[studentName].subjects[subject];
                    stats[subject] = subjectData.solved > 0 ? Math.round((subjectData.correct/subjectData.solved)*100) : 0;
                }
                const q = query(collection(db, 'weeklyStats'), where('uid', '==', uid));
                const snapshot = await getDocs(q);
                if (snapshot.empty) {
                    await addDoc(collection(db, 'weeklyStats'), { uid, stats, updatedAt: Timestamp.now() });
                } else {
                    await updateDoc(doc(db, 'weeklyStats', snapshot.docs[0].id), { stats, updatedAt: Timestamp.now() });
                }
            }
        }

        window.showCoachDetailView = async function(coachUid, coachName) {
            contentContainer.innerHTML = `
                <button class="btn-secondary btn-small" style="margin-bottom: 15px;" onclick="window.loadAllCoaches()">â€¹ TÃ¼m KoÃ§lara Geri DÃ¶n</button>
                <h3>${coachName}</h3>
                <div class="sub-tabs">
                    <button class="sub-tab active" data-tab="students">Ã–ÄŸrenciler</button>
                    <button class="sub-tab" data-tab="stats">HaftalÄ±k Ä°statistikler</button>
                </div>
                <div id="coachDetailContent"><div class="loading">YÃ¼kleniyor...</div></div>`;
            const coachDetailContent = document.getElementById('coachDetailContent');
            const showDetailTab = async (tabName) => {
                coachDetailContent.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
                if (tabName === 'students') {
                    await loadCoachStudents(coachUid, coachDetailContent);
                } else if (tabName === 'stats') {
                    await loadCoachStats(coachUid, coachDetailContent);
                }
            };
            setupTabEvents(showDetailTab, '.sub-tab');
            await showDetailTab('students');
        };
        
        async function loadCoachStudents(coachUid, container) {
            container.innerHTML = '<div class="loading">Ã–ÄŸrenciler yÃ¼kleniyor...</div>';
            const q = query(collection(db, 'users'), where('coachId', '==', coachUid));
            const snapshot = await getDocs(q);
            if (snapshot.empty) { container.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Bu koÃ§a atanmÄ±ÅŸ Ã¶ÄŸrenci yok.</p>'; return; }
            let html = '';
            for (const docSnap of snapshot.docs) {
                const student = docSnap.data();
                const stats = await getStudentStats(student.uid);
                html += `
                    <div class="card">
                        <div class="card-title">${student.name}</div>
                        <div style="font-size: 13px; color: #999;">${student.email}</div>
                        <div class="stats-info">
                           <span>ğŸ“ ${stats.total} soru</span><span>âœ… ${stats.correct} doÄŸru</span><span>âŒ ${stats.wrong} yanlÄ±ÅŸ</span>
                        </div>
                    </div>`;
            }
            container.innerHTML = html;
        }

    </script>
</body>
</html>
