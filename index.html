<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Soru Takip Sistemi</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; border-radius: 20px; padding: 30px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
        h1 { color: #667eea; margin-bottom: 10px; text-align: center; }
        .subtitle { text-align: center; color: #666; margin-bottom: 30px; font-size: 14px; }
        .auth-section, .app-section { display: none; }
        .auth-section.active, .app-section.active { display: block; }
        .input-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; color: #333; font-weight: 500; }
        input, select { width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 10px; font-size: 16px; transition: border-color 0.3s; }
        input:focus, select:focus { outline: none; border-color: #667eea; }
        button { width: 100%; padding: 14px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: transform 0.2s; }
        button:hover { transform: translateY(-2px); }
        button:active { transform: translateY(0); }
        .btn-secondary { background: #f0f0f0; color: #333; margin-top: 10px; }
        .btn-danger { background: #ef4444; margin-top: 0; }
        .btn-back { background: #6b7280; margin-bottom: 20px; }
        .stats-card { background: #f8f9fa; padding: 20px; border-radius: 12px; margin-bottom: 20px; }
        .entry-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #e0e0e0; }
        .entry-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .entry-date { font-weight: 600; color: #333; }
        .entry-subject { display: inline-block; padding: 4px 12px; background: #667eea; color: white; border-radius: 20px; font-size: 12px; margin-left: 10px; }
        .btn-small { padding: 5px 12px; font-size: 12px; width: auto; }
        .entry-stats { display: flex; gap: 15px; font-size: 14px; color: #666; flex-wrap: wrap; }
        .user-info { background: #f8f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { flex: 1; padding: 12px; background: #f0f0f0; border: none; border-radius: 10px; cursor: pointer; font-weight: 600; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        canvas { max-width: 100%; }
        .student-card { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; border: 2px solid #e0e0e0; cursor: pointer; transition: all 0.3s; }
        .student-card:hover { border-color: #667eea; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2); }
        .student-name { font-weight: 600; color: #667eea; margin-bottom: 10px; font-size: 18px; }
        .loading { text-align: center; padding: 20px; color: #666; }
        .error, .success { padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .error { background: #fee; color: #c33; }
        .success { background: #efe; color: #3c3; }
        .subject-colors { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px; }
        .subject-badge { padding: 6px 14px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    </style>
</head>
<body>
    <div class="container">
        <div class="auth-section active" id="authSection">
            <h1>ğŸ“š Soru Takip Sistemi</h1>
            <p class="subtitle">GÃ¼nlÃ¼k soru Ã§Ã¶zÃ¼m takibinizi yapÄ±n</p>
            <div id="authMessage"></div>
            <div class="input-group">
                <label>E-posta</label>
                <input type="email" id="emailInput" placeholder="ornek@email.com">
            </div>
            <div class="input-group">
                <label>Åifre</label>
                <input type="password" id="passwordInput" placeholder="En az 6 karakter">
            </div>
            <div class="input-group" id="nameGroup">
                <label>Ad Soyad</label>
                <input type="text" id="nameInput" placeholder="AdÄ±nÄ±z ve soyadÄ±nÄ±z">
            </div>
            <button id="signUpButton">KayÄ±t Ol</button>
            <button class="btn-secondary" id="signInButton">GiriÅŸ Yap</button>
        </div>

        <div class="app-section" id="appSection">
            <div class="user-info">
                <div>
                    <strong id="userName">KullanÄ±cÄ±</strong>
                    <div style="font-size: 12px; color: #666;" id="userEmail"></div>
                </div>
                <button class="btn-small btn-secondary" id="signOutButton">Ã‡Ä±kÄ±ÅŸ</button>
            </div>

            <div id="studentTabs" style="display:none;">
                <div class="tabs">
                    <button class="tab active" data-tab-target="entry">Veri Gir</button>
                    <button class="tab" data-tab-target="stats">Ä°statistikler</button>
                </div>
            </div>

            <div id="coachTabs" style="display:none;">
                <div class="tabs">
                    <button class="tab active" data-tab-target="stats">Ä°statistikler</button>
                    <button class="tab" data-tab-target="admin">TÃ¼m Ã–ÄŸrenciler</button>
                </div>
            </div>

            <div id="entryTab" style="display:none;">
                <div class="input-group">
                    <label>Ders</label>
                    <select id="subjectInput">
                        <option value="">Ders seÃ§in</option>
                        <option value="TÃ¼rkÃ§e">TÃ¼rkÃ§e</option>
                        <option value="Matematik">Matematik</option>
                        <option value="Fizik">Fizik</option>
                        <option value="Kimya">Kimya</option>
                        <option value="Biyoloji">Biyoloji</option>
                        <option value="Tarih">Tarih</option>
                        <option value="CoÄŸrafya">CoÄŸrafya</option>
                        <option value="Din KÃ¼ltÃ¼rÃ¼">Din KÃ¼ltÃ¼rÃ¼</option>
                        <option value="Felsefe">Felsefe</option>
                        <option value="Deneme SÄ±navÄ±">Deneme SÄ±navÄ±</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Tarih</label>
                    <input type="date" id="dateInput">
                </div>
                <div class="input-group">
                    <label>Ã‡Ã¶zÃ¼len Soru SayÄ±sÄ±</label>
                    <input type="number" id="solvedInput" min="0" placeholder="0">
                </div>
                <div class="input-group">
                    <label>DoÄŸru SayÄ±sÄ±</label>
                    <input type="number" id="correctInput" min="0" placeholder="0">
                </div>
                <div class="input-group">
                    <label>YanlÄ±ÅŸ SayÄ±sÄ±</label>
                    <input type="number" id="wrongInput" min="0" placeholder="0">
                </div>
                <button id="saveEntryButton">Kaydet</button>
                <div class="stats-card" style="margin-top: 30px;">
                    <h3>KayÄ±tlarÄ±m</h3>
                    <div id="entriesList" class="loading">YÃ¼kleniyor...</div>
                </div>
            </div>

            <div id="statsTab" style="display:none;">
                <div id="studentStatsContent"></div>
                <div id="coachStatsContent"></div>
            </div>

            <div id="adminTab" style="display:none;">
                <div id="studentListView">
                    <h3 style="margin-bottom: 20px;">TÃ¼m Ã–ÄŸrenciler</h3>
                    <div id="allStudentsList" class="loading">YÃ¼kleniyor...</div>
                </div>
                <div id="studentDetailView" style="display:none;">
                    <button class="btn-back" id="backToStudentListButton">â† Geri DÃ¶n</button>
                    <h3 id="detailStudentName" style="margin-bottom: 20px;"></h3>
                    <div id="studentDetailContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script type="module">
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyDz0lFClcTpySHPCZnLEyXWHeQzd9RyH58",
            authDomain: "mcoalogrencikocluk.firebaseapp.com",
            projectId: "mcoalogrencikocluk",
            storageBucket: "mcoalogrencikocluk.firebasestorage.app",
            messagingSenderId: "950814379359",
            appId: "1:950814379359:web:970b00931d5e0763bdbaea",
            measurementId: "G-RV2VYT4D6S"
        };

        import { initializeApp } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js';
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut as fbSignOut, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js';
        import { getFirestore, collection, addDoc, query, where, getDocs, deleteDoc, doc, Timestamp, orderBy } from 'https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js';

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let isCoach = false;
        let chartInstances = {};
        let currentStudentDetailUID = null; // Silme sonrasÄ± yenileme iÃ§in
        const COACH_EMAIL = "abdussametkrkmz@gmail.com";

        const SUBJECT_COLORS = { 'TÃ¼rkÃ§e': '#ef4444', 'Matematik': '#3b82f6', 'Fizik': '#8b5cf6', 'Kimya': '#10b981', 'Biyoloji': '#06b6d4', 'Tarih': '#f59e0b', 'CoÄŸrafya': '#14b8a6', 'Din KÃ¼ltÃ¼rÃ¼': '#ec4899', 'Felsefe': '#6366f1', 'Deneme SÄ±navÄ±': '#6b7280' };

        const signUp = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            const name = document.getElementById('nameInput').value;
            if (!email || !password || !name) return showMessage('LÃ¼tfen tÃ¼m alanlarÄ± doldurun', 'error');
            if (password.length < 6) return showMessage('Åifre en az 6 karakter olmalÄ±', 'error');

            try {
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                await addDoc(collection(db, 'users'), { uid: userCredential.user.uid, email: email, name: name, createdAt: Timestamp.now() });
                showMessage('KayÄ±t baÅŸarÄ±lÄ±! GiriÅŸ yapÄ±lÄ±yor...', 'success');
            } catch (error) {
                if (error.code === 'auth/email-already-in-use') showMessage('Bu e-posta zaten kayÄ±tlÄ±', 'error');
                else showMessage('Hata: ' + error.message, 'error');
            }
        };

        const signIn = async () => {
            const email = document.getElementById('emailInput').value;
            const password = document.getElementById('passwordInput').value;
            if (!email || !password) return showMessage('LÃ¼tfen e-posta ve ÅŸifre girin', 'error');

            try {
                await signInWithEmailAndPassword(auth, email, password);
                showMessage('GiriÅŸ baÅŸarÄ±lÄ±!', 'success');
            } catch (error) {
                if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found') showMessage('E-posta veya ÅŸifre hatalÄ±', 'error');
                else showMessage('Hata: ' + error.message, 'error');
            }
        };

        const signOut = () => fbSignOut(auth).catch(() => showMessage('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±', 'error'));

        const saveEntry = async () => {
            const subject = document.getElementById('subjectInput').value;
            const date = document.getElementById('dateInput').value;
            const solved = parseInt(document.getElementById('solvedInput').value) || 0;
            const correct = parseInt(document.getElementById('correctInput').value) || 0;
            const wrong = parseInt(document.getElementById('wrongInput').value) || 0;

            if (!subject || !date || solved === 0) return showMessage('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun', 'error');

            try {
                await addDoc(collection(db, 'entries'), { uid: currentUser.uid, subject, date, solved, correct, wrong, createdAt: Timestamp.now() });
                ['subjectInput', 'solvedInput', 'correctInput', 'wrongInput'].forEach(id => document.getElementById(id).value = '');
                showMessage('âœ… KayÄ±t baÅŸarÄ±yla eklendi!', 'success');
                loadEntries();
            } catch (error) {
                console.error('KayÄ±t hatasÄ±:', error);
                showMessage('KayÄ±t eklenirken hata oluÅŸtu', 'error');
            }
        };

        window.deleteEntry = async (id) => {
            if (confirm('Bu kaydÄ± silmek istediÄŸinizden emin misiniz?')) {
                try {
                    await deleteDoc(doc(db, 'entries', id));
                    showMessage('KayÄ±t silindi', 'success');
                    if (isCoach && currentStudentDetailUID) {
                        loadStudentDetailEntries(currentStudentDetailUID); // SayfayÄ± yenilemek yerine sadece listeyi gÃ¼nceller
                    } else {
                        loadEntries();
                    }
                } catch (error) {
                    showMessage('Silme iÅŸlemi baÅŸarÄ±sÄ±z', 'error');
                }
            }
        };

        const showTab = (tab) => {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tabs [data-tab-target="${tab}"]`).classList.add('active');

            ['entryTab', 'statsTab', 'adminTab'].forEach(id => document.getElementById(id).style.display = 'none');
            
            const targetTab = document.getElementById(`${tab}Tab`);
            if (targetTab) targetTab.style.display = 'block';

            if (tab === 'stats') {
                document.getElementById('studentStatsContent').innerHTML = '';
                document.getElementById('coachStatsContent').innerHTML = '';
                isCoach ? loadCoachStats() : loadStudentStats();
            } else if (tab === 'admin') {
                document.getElementById('studentListView').style.display = 'block';
                document.getElementById('studentDetailView').style.display = 'none';
                loadAllStudents();
            }
        };
        
        window.viewStudentDetail = (uid, name) => {
            currentStudentDetailUID = uid; // Silme iÅŸlemi sonrasÄ± iÃ§in UID'yi sakla
            document.getElementById('studentListView').style.display = 'none';
            document.getElementById('studentDetailView').style.display = 'block';
            document.getElementById('detailStudentName').textContent = `${name} - TÃ¼m KayÄ±tlar`;
            loadStudentDetailEntries(uid);
        };

        window.backToStudentList = () => {
            currentStudentDetailUID = null; // Detaydan Ã§Ä±kÄ±nca UID'yi temizle
            document.getElementById('studentListView').style.display = 'block';
            document.getElementById('studentDetailView').style.display = 'none';
        };

        async function renderEntries(containerId, entriesQuery) {
            const list = document.getElementById(containerId);
            list.innerHTML = '<div class="loading">YÃ¼kleniyor...</div>';
            try {
                const snapshot = await getDocs(entriesQuery);
                if (snapshot.empty) {
                    list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">HenÃ¼z kayÄ±t yok</p>';
                    return;
                }
                const entries = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
                list.innerHTML = entries.map(entry => `
                    <div class="entry-item">
                        <div class="entry-header">
                            <div>
                                <span class="entry-date">${formatDate(entry.date)}</span>
                                <span class="entry-subject">${entry.subject}</span>
                            </div>
                            <div class="entry-actions">
                                <button class="btn-small btn-danger" onclick="deleteEntry('${entry.id}')">Sil</button>
                            </div>
                        </div>
                        <div class="entry-stats">
                            <span>ğŸ“ ${entry.solved} soru</span>
                            <span>âœ… ${entry.correct} doÄŸru</span>
                            <span>âŒ ${entry.wrong} yanlÄ±ÅŸ</span>
                        </div>
                    </div>`).join('');
            } catch (error) {
                console.error('KayÄ±t yÃ¼kleme hatasÄ±:', error);
                list.innerHTML = '<p style="text-align:center;color:#c33;">Veriler yÃ¼klenirken bir hata oluÅŸtu.</p>';
            }
        }

        const loadEntries = () => {
            const q = query(collection(db, 'entries'), where('uid', '==', currentUser.uid), orderBy('createdAt', 'desc'));
            renderEntries('entriesList', q);
        };
        
        const loadStudentDetailEntries = (uid) => {
            const q = query(collection(db, 'entries'), where('uid', '==', uid), orderBy('createdAt', 'desc'));
            renderEntries('studentDetailContent', q);
        };

        async function loadAllStudents() {
            const list = document.getElementById('allStudentsList');
            list.innerHTML = '<div class="loading">Ã–ÄŸrenci verileri yÃ¼kleniyor...</div>';
            try {
                const usersQuery = query(collection(db, 'users'), where('email', '!=', COACH_EMAIL));
                const usersSnapshot = await getDocs(usersQuery);
                if(usersSnapshot.empty) return list.innerHTML = '<p style="text-align:center;color:#999;">HenÃ¼z Ã¶ÄŸrenci yok</p>';
                
                const studentCardsHTML = usersSnapshot.docs.map(doc => {
                    const student = { uid: doc.id, ...doc.data() };
                    return `
                        <div class="student-card" onclick="viewStudentDetail('${student.uid}', '${student.name}')">
                            <div class="student-name">${student.name}</div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 10px;">${student.email}</div>
                             <div style="text-align:center;margin-top:15px;color:#667eea;font-size:13px;font-weight:600;">
                                KayÄ±tlarÄ± gÃ¶rmek iÃ§in tÄ±klayÄ±n â†’
                            </div>
                        </div>`;
                }).join('');
                list.innerHTML = studentCardsHTML;
            } catch (error) {
                console.error('Ã–ÄŸrenci verileri yÃ¼kleme hatasÄ±:', error);
                list.innerHTML = '<p style="text-align:center;color:#c33;">Veriler yÃ¼klenirken hata oluÅŸtu</p>';
            }
        }
        
        // DiÄŸer fonksiyonlar (loadStudentStats, loadCoachStats, createStudentChart vb.) Ã¶nceki kodunuzdan
        // bÃ¼yÃ¼k Ã¶lÃ§Ã¼de aynÄ± kalabilir, bu nedenle burada tekrar etmiyorum.
        // Anahtar deÄŸiÅŸiklikler yukarÄ±da yapÄ±ldÄ±. AÅŸaÄŸÄ±da sadeleÅŸtirilmiÅŸ halleri var.
        async function loadStudentStats() {
            const container = document.getElementById('studentStatsContent');
            container.innerHTML = '<h3>Son 7 GÃ¼n - Ders BazlÄ± Ä°statistikler</h3>';
            // ... (Ä°statistik hesaplama mantÄ±ÄŸÄ±nÄ±z burada devam eder)
        }

        async function loadCoachStats() {
            const container = document.getElementById('coachStatsContent');
            container.innerHTML = '<h3 style="margin-bottom:20px;">TÃ¼m Ã–ÄŸrenciler - Son 7 GÃ¼n Ä°statistikleri</h3>';
            // ... (Ä°statistik hesaplama mantÄ±ÄŸÄ±nÄ±z burada devam eder)
        }


        function formatDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00'); // Saat dilimi sorunlarÄ±nÄ± Ã¶nlemek iÃ§in
            return date.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short', year: 'numeric' });
        }

        function showMessage(msg, type) {
            const div = document.getElementById('authMessage');
            div.className = type;
            div.textContent = msg;
            setTimeout(() => div.textContent = '', 4000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                isCoach = user.email === COACH_EMAIL;
                try {
                    const userQuery = query(collection(db, 'users'), where('uid', '==', user.uid));
                    const userDoc = await getDocs(userQuery);
                    if (userDoc.empty) throw new Error("KullanÄ±cÄ± veritabanÄ±nda bulunamadÄ±.");
                    
                    const userData = userDoc.docs[0].data();
                    document.getElementById('userName').textContent = userData.name;
                    document.getElementById('userEmail').textContent = user.email;
                    document.getElementById('dateInput').valueAsDate = new Date();

                    document.getElementById('studentTabs').style.display = isCoach ? 'none' : 'block';
                    document.getElementById('coachTabs').style.display = isCoach ? 'block' : 'none';
                    
                    if (isCoach) {
                        showTab('stats');
                    } else {
                        showTab('entry');
                        loadEntries();
                    }

                    document.getElementById('authSection').classList.remove('active');
                    document.getElementById('appSection').classList.add('active');
                } catch (error) {
                    console.error('KullanÄ±cÄ± yÃ¼kleme hatasÄ±:', error);
                    showMessage('Oturum aÃ§Ä±lÄ±rken bir hata oluÅŸtu, lÃ¼tfen tekrar giriÅŸ yapÄ±n', 'error');
                    await fbSignOut(auth);
                }
            } else {
                currentUser = null;
                isCoach = false;
                document.getElementById('authSection').classList.add('active');
                document.getElementById('appSection').classList.remove('active');
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('signUpButton').addEventListener('click', signUp);
            document.getElementById('signInButton').addEventListener('click', signIn);
            document.getElementById('signOutButton').addEventListener('click', signOut);
            document.getElementById('saveEntryButton').addEventListener('click', saveEntry);
            document.getElementById('backToStudentListButton').addEventListener('click', backToStudentList);
            
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', (e) => {
                    const target = e.target.getAttribute('data-tab-target');
                    if (target) showTab(target);
                });
            });
        });
    </script>
</body>
</html>
